<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trading -  Horizont</title>
  <link rel="stylesheet" href="../../styles/base/main.css" />
  <link rel="stylesheet" href="../../styles/pages/mit-theme.css" />
  <link rel="stylesheet" href="../../styles/pages/trading.css" />
  <link rel="stylesheet" href="../../styles/components/footer.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet"/>
</head>
<body>
<!-- Barra de Navegación -->
<nav class="navbar">
  <div class="logo">
    <img src="../../Resources/HORIZONT.png" class="logo-img" alt="HORIZONT">
  </div>
  <ul class="nav-links">
    <li><a href="index.html">Inicio</a></li>
    <li><a href="trading.html" class="active">Trading</a></li>
    <li><a href="portfolio.html">Portafolio</a></li>
    <li>
      <a href="notifications.html" class="notifications-link" title="Notificaciones">
        <span class="material-icons">notifications</span>
        <span class="visually-hidden">Notificaciones</span>
      </a>
    </li>
    <li><a href="admin.html">Administración</a></li>
  </ul>
  <!-- Estado de sesión -->
  <div id="loginLink">
    <a href="login.html" class="btn-login-link">Iniciar Sesión</a>
  </div>
  <div class="user-menu" id="userMenu" style="display:none; align-items:center; gap:1rem;">
    <span>Hola, <strong id="userName"></strong></span>
    <button id="logoutBtn" class="btn-logout">Cerrar Sesión</button>
  </div>
</nav>

<!-- Panel de Trading -->
<main class="trading-container trading-page">
  <!-- Panel Izquierdo - Lista de Símbolos -->
 <aside class="symbols-panel">
  <div class="search-bar">
  <input type="text" id="searchInput" placeholder="Buscar símbolo...">
  </div>
  <div class="symbols-list">
    <div class="watchlist-table-wrapper">
      <table class="watchlist-table">
        <thead>
          <tr>
            <th>Símbolo</th>
            <th class="text-right">Precio</th>
            <th class="text-right">Cambio</th>
          </tr>
        </thead>
        <tbody id="marketDataBody">
          <!-- filas inyectadas por JS -->
        </tbody>
      </table>
    </div>
  </div>
</aside>


  <!-- Panel Central - Gráfico -->
  <section class="chart-panel">
    <div class="chart-header">
      <h2 id="selectedSymbolHeader">Símbolo - Empresa</h2>
      <div class="chart-controls">
        <button class="btn-timeframe active">1D</button>
        <button class="btn-timeframe">1S</button>
        <button class="btn-timeframe">1M</button>
        <button class="btn-timeframe">1A</button>
      </div>
    </div>
    <div class="chart-container">
      <canvas id="symbolChart"></canvas>
    </div>

  </section>

  <!-- Panel Derecho - Órdenes y Posiciones -->
  <aside class="orders-panel">
    <div class="panel-section">
      <h3>Nueva Orden</h3>
      <form id="orderForm" class="order-form">
        <input type="text" name="symbol" placeholder="Símbolo (ej: AAPL)" />
        <select name="orderType">
          <option value="market">Orden de Mercado</option>
          <option value="limit">Orden Límite</option>
        </select>
        <input type="number" name="quantity" placeholder="Cantidad" min="1" />
        <input type="number" name="price" placeholder="Precio" step="0.01" />
        <div class="order-buttons">
          <button type="button" class="btn-buy">Comprar</button>
          <button type="button" class="btn-sell">Vender</button>
        </div>
      </form>
    </div>

    <div class="panel-section">
      <h3>Posiciones Abiertas</h3>
      <div class="positions-list">
        <!-- Se llenará dinámicamente -->
      </div>
    </div>

    <div class="panel-section">
      <h3>Historial de Órdenes</h3>
      <div class="order-history">
        <!-- Se llenará dinámicamente -->
      </div>
    </div>
  </aside>
</main>

<!-- Footer -->
<div id="footer-placeholder"></div>

<!-- Script: carga 3 símbolos desde Finnhub -->

  <!-- Scripts de Trading: tabla + gráfico integrados -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const API_BASE    = 'http://localhost:8080/api/market';
  const symbols     = ['AAPL','GOOGL','MSFT','AMZN','TSLA','META','NFLX','NVDA','AMD','INTC','IBM','ORCL','BABA','DIS','V','JPM','BAC','WMT','PFE','JNJ'];
  const tbody       = document.getElementById('marketDataBody');
  let chartInstance = null;
  let currentSymbol = null;

  // 1) Cargo la tabla de símbolos
  tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#888">Cargando símbolos…</td></tr>`;
  try {
    const res   = await fetch(`${API_BASE}/quotes?symbols=${symbols.join(',')}`);
    if (!res.ok) throw new Error('Respuesta ' + res.status);
    const data  = await res.json();

    tbody.innerHTML = '';
    data.forEach(item => {
      const { symbol, quote } = item;
      const cp  = quote.c, pc = quote.pc;
      const pct = pc ? ((cp - pc)/pc*100).toFixed(2) : '—';
      const cls = (cp >= pc ? 'positive' : 'negative');

      const tr = document.createElement('tr');
      tr.classList.add('market-row');
      tr.innerHTML = `
        <td class="symbol-cell">${symbol}</td>
        <td class="price text-right">${cp!=null?'$'+cp.toFixed(2):'—'}</td>
        <td class="change ${cls} text-right">${pct}%</td>
      `;

      tr.addEventListener('mouseenter', () => tr.style.backgroundColor = 'rgba(0,0,0,0.05)');
      tr.addEventListener('mouseleave', () => tr.style.backgroundColor = 'transparent');

      tr.addEventListener('click', () => {
        currentSymbol = symbol;
        document.querySelectorAll('.market-row').forEach(r => r.classList.remove('selected'));
        tr.classList.add('selected');
        showSymbolChart(symbol, '1D').catch(err => alert('Error al cargar gráfico: ' + err.message));
      });

      tbody.appendChild(tr);
    });

    // auto-selecciona el primero
    if (symbols.length) {
      currentSymbol = symbols[0];
      document.querySelector('.market-row')?.classList.add('selected');
      showSymbolChart(currentSymbol, '1D').catch(()=>{});
    }

  } catch (err) {
    console.error('Error al cargar símbolos:', err);
    tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#888">No se pudieron cargar los símbolos.</td></tr>`;
  }

  // 2) Función para mostrar el gráfico con fallback de datos
  async function showSymbolChart(symbol, timeframe = '1D') {
    const res1 = await fetch(`${API_BASE}/history?symbol=${symbol}&timeframe=${timeframe}`);
    if (!res1.ok) throw new Error('No se pudo cargar historial');
    let { t, c } = await res1.json();

    // fallback: datos “dummy” si viene vacío
    if (!t.length) {
      const now = Math.floor(Date.now()/1000);
      t = Array.from({length:12}, (_,i) => now - (11-i)*2*3600);
      // obtener precio actual como base
      let base = 100;
      try {
        const qres = await fetch(`${API_BASE}/quotes?symbols=${symbol}`);
        if (qres.ok) {
          const qd = await qres.json();
          base = qd[0]?.quote.c || base;
        }
      } catch{}
      c = t.map((_,i) => +(base * (0.95 + 0.1*(i/11))).toFixed(2));
    }

    const labels = t.map(ts => {
      const d = new Date(ts*1000);
      return d.getHours() + ':' + String(d.getMinutes()).padStart(2,'0');
    });

    const data = { labels, datasets: [{
      label: `${symbol} precio (USD)`,
      data: c,
      fill: false,
      tension: 0.1
    }]};

    if (chartInstance) chartInstance.destroy();
    const ctx = document.getElementById('symbolChart').getContext('2d');
    chartInstance = new Chart(ctx, {
      type: 'line',
      data,
      options: {
        scales: {
          x: { display: true, title: { display: true, text: 'Hora' } },
          y: { display: true, title: { display: true, text: 'Precio (USD)' } }
        }
      }
    });

    document.getElementById('selectedSymbolHeader')
      .textContent = `${symbol} — ${timeframe==='1D'?'Últimas 24h':timeframe}`;
  }

  // 3) Timeframe buttons
  document.querySelectorAll('.btn-timeframe').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.btn-timeframe').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      if (currentSymbol) {
        showSymbolChart(currentSymbol, btn.textContent)
          .catch(err => alert('Error al cambiar timeframe: ' + err.message));
      }
    });
  });

  // 4) Filtrado por búsqueda
  document.getElementById('searchInput').addEventListener('input', () => {
    const filter = document.getElementById('searchInput').value.toUpperCase();
    document.querySelectorAll('.market-row').forEach(row => {
      const sym = row.querySelector('.symbol-cell').textContent.toUpperCase();
      row.style.display = sym.includes(filter) ? '' : 'none';
    });
  });
});
</script>



<!-- Script para manejar sesión, protección de ruta y navbar -->
<script>
  function updateNavbar() {
    const user = JSON.parse(localStorage.getItem('usuario'));
    const loginLink = document.getElementById('loginLink');
    const userMenu = document.getElementById('userMenu');
    const userName = document.getElementById('userName');

    if (user) {
      // Si hay sesión, muestro navbar
      loginLink.style.display = 'none';
      userName.textContent = user.nombre;
      userMenu.style.display = 'flex';
    } else {
      // Si no hay sesión, redirijo a index
      window.location.href = 'index.html';
    }
  }

  function logout() {
    localStorage.removeItem('usuario');
    // Tras logout, vuelvo al home
    window.location.href = 'index.html';
  }

  // Listener para botón de logout
  document.getElementById('logoutBtn')?.addEventListener('click', logout);
  // Al cargar la página, primero protejo la ruta, luego actualizo la navbar
  window.addEventListener('load', updateNavbar);
</script>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="../../js/include-components.js"></script>

</body>
</html>
